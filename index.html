<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>EthOs Fight Code</title>
<style>
body { margin: 0; overflow: hidden; background: #222; }
#gameCanvas { display: block; margin: auto; background: #333; }
#joystick { position: absolute; bottom: 20px; left: 20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; touch-action: none; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="joystick"></div>
<audio id="bgm" src="bg-music.mp3" autoplay loop></audio>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const joystick = document.getElementById('joystick');
let joyX = 0, joyY = 0;

// Player sprite setup
let sprite = new Image();
sprite.src = 'char_sprites.png';
const frameWidth = 32, frameHeight = 32, framesPerRow = 3;
let frame = 0, lastFrameTime = 0, frameInterval = 150;
let player = { x: 0, y: 0, hp: 100, speed: 2, damage: 10, level: 1, exp: 0 };

let creeps = [];
let mapOffsetX = 0, mapOffsetY = 0;

// Joystick controls
joystick.addEventListener('touchmove', e => {
  e.preventDefault();
  let rect = joystick.getBoundingClientRect();
  let x = e.touches[0].clientX - rect.left - rect.width / 2;
  let y = e.touches[0].clientY - rect.top - rect.height / 2;
  joyX = Math.max(-1, Math.min(1, x / (rect.width / 2)));
  joyY = Math.max(-1, Math.min(1, y / (rect.height / 2)));
});
joystick.addEventListener('touchend', () => { joyX = 0; joyY = 0; });

function drawPlayerSprite() {
  let row = 2;
  if (joyY < 0) row = 0;
  else if (joyY > 0) row = 2;
  else if (joyX !== 0) row = 1;
  if (Date.now() - lastFrameTime > frameInterval && (joyX !== 0 || joyY !== 0)) {
    frame = (frame + 1) % framesPerRow;
    lastFrameTime = Date.now();
  }
  ctx.drawImage(sprite, frame * frameWidth, row * frameHeight, frameWidth, frameHeight,
                canvas.width/2 - frameWidth/2, canvas.height/2 - frameHeight/2, frameWidth, frameHeight);
}

function spawnCreep() {
  creeps.push({ x: Math.random()*2000-1000, y: Math.random()*2000-1000, hp: 100, speed: 1 });
}

function updateCreeps() {
  creeps.forEach(c => {
    let dx = player.x - c.x;
    let dy = player.y - c.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    let randomness = (Math.random() - 0.5) * 0.5;
    let angle = Math.atan2(dy, dx) + randomness;
    c.x += Math.cos(angle) * c.speed;
    c.y += Math.sin(angle) * c.speed;
  });
}

function drawCreeps() {
  ctx.fillStyle = 'red';
  creeps.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x - mapOffsetX + canvas.width/2, c.y - mapOffsetY + canvas.height/2, 15, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = 'green';
    ctx.fillRect(c.x - mapOffsetX + canvas.width/2 - 15, c.y - mapOffsetY + canvas.height/2 - 25, 30 * (c.hp/100), 4);
    ctx.fillStyle = 'red';
  });
}

function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  player.x += joyX * player.speed;
  player.y += joyY * player.speed;
  mapOffsetX = player.x;
  mapOffsetY = player.y;
  drawPlayerSprite();
  updateCreeps();
  drawCreeps();
  requestAnimationFrame(gameLoop);
}

for (let i = 0; i < 5; i++) spawnCreep();
gameLoop();
</script>
</body>
</html>
